# README.md

Mil Mapper — загрузка спутниковых тайлов Google Static Maps с построением километровой сетки СК‑42/Гаусса–Крюгера и подписями

Возможности
- Асинхронная загрузка тайлов Google Static Maps (httpx + asyncio) с ограничением параллелизма.
- Автоподбор zoom под лимит итогового размера кадра (по количеству пикселей).
- Сборка (мозаика) и центрированный кроп.
- Поворот карты с припуском, чтобы линии километровой сетки были строго горизонтальны/вертикальны без «срезанных» углов.
- Белая полупрозрачная маска карты (опционально).
- Построение точной километровой сетки в СК‑42 / Гаусса–Крюгера (EPSG:284xx).
- Подписи координат у краёв (только 4-й и 5-й младшие знаки), с жёлтой подложкой и жирным шрифтом.
- Единая строка прогресса; для «монолитных» операций — живой спиннер.

Требования
- Python 3.13+
- Библиотеки: Pillow, httpx, pyproj
- Ключ Google Static Maps API

Установка
1) Установите зависимости в вашем окружении Python (poetry или любым иным способом):
   - Pillow
   - httpx
   - pyproj

2) Создайте .env в корне проекта:
   API_KEY=ваш_api_ключ

3) Запуск:
   python main.py

Настройки (main.py)
- GOOGLE_STATIC_MAPS_URL — базовый URL Google Static Maps API.
- STATIC_SIZE_PX — размер статик-тайла (px), по умолчанию 640 (со scale=2 фактически ~1280).
- STATIC_SCALE — масштаб статик-тайла (1 или 2).
- MAX_ZOOM — верхняя граница зума; реальный зум может уменьшиться автоматически при больших размерах.
- EARTH_RADIUS_M, TILE_SIZE — параметры Web Mercator.
- ASYNC_MAX_CONCURRENCY — параллелизм загрузки.
- MAX_OUTPUT_PIXELS — лимит итогового кадра по количеству пикселей (без припусков).
- PIL_DISABLE_LIMIT — отключить защиту Pillow от «бомб декомпрессии».
- ROTATION_PAD_RATIO, ROTATION_PAD_MIN_PX — припуск под поворот (чтобы не «резало» углы).
- API_KEY_ENV_VAR — имя переменной окружения для ключа (по умолчанию API_KEY).
- CENTER_LAT_SK42, CENTER_LNG_SK42 — центр прямоугольника в СК‑42 (градусы).
- WIDTH_M, HEIGHT_M — размеры области (метры).
- OUTPUT_PATH — путь к сохранению.
- ZOOM — желаемый зум.
- GRID_STEP_M — шаг сетки (метры, 1000 м = 1 км).
- GRID_COLOR, GRID_WIDTH_PX — стиль линий сетки.
- GRID_FONT_SIZE — размер шрифта подписей (px).
- GRID_FONT_PATH — путь к TTF/OTF обычного шрифта (если None — используется DejaVu*).
- GRID_FONT_BOLD, GRID_FONT_PATH_BOLD — использовать жирный и/или указать путь к жирному шрифту.
- GRID_TEXT_COLOR — цвет текста.
- GRID_TEXT_OUTLINE_COLOR, GRID_TEXT_OUTLINE_WIDTH — обводка текста для читаемости.
- GRID_TEXT_MARGIN — отступ текста от края.
- GRID_LABEL_BG_COLOR, GRID_LABEL_BG_PADDING — жёлтая подложка под подписью и её внутр. отступ.
- ENABLE_WHITE_MASK, MASK_OPACITY — включение и прозрачность белой маски.

Логика работы
1) Подготовка:
   - Чтение .env, получение API ключа.
   - Инициализация трансформеров СК‑42<->WGS84 и СК‑42/ГК.
   - Конвертация центра (СК‑42) в WGS84.
   - Автоподбор zoom под лимит итогового размера.
   - Расчёт сетки статик-тайлов с припуском под последующий поворот.

2) Загрузка:
   - Асинхронная мультизагрузка всех статик-тайлов (PNG), с повторами.

3) Сборка и обработка:
   - Склейка тайлов в общий холст.
   - Кроп «расширенной» области.
   - Поворот изображения с expand=True + центр-кроп к исходному размеру.
   - Наложение белой маски (если включено).
   - Построение сетки (СК‑42/ГК), строго по экранным осям.
   - Подписи у краёв (две последние цифры тысяч), с жёлтой подложкой и жирным шрифтом.

4) Сохранение:
   - Сохранение итогового файла.
   - Принудительный fsync (по возможности).

Подсказки
- Увеличивайте/уменьшайте GRID_FONT_SIZE для читаемости подписей.
- При слишком больших WIDTH_M/HEIGHT_M и/или ZOOM — итоговый кадр может превысить MAX_OUTPUT_PIXELS; зум будет автоматически снижен.
- При ошибках 429 попробуйте уменьшить ASYNC_MAX_CONCURRENCY или добавить больше задержек/повторов.

Формат .env
- В корне проекта создайте файл .env:
  API_KEY=ваш_api_ключ

- Допустимы комментарии (# ...) и пустые строки.

Ограничения
- Точность СК‑42↔WGS84 зависит от наличия региональных параметров и сеток в установленном у вас PROJ.
- Google Static Maps имеет квоты и ограничения; следите за расходами.

Лицензия
- Используйте на свой страх и риск с соблюдением условий сервисов и данных.